# terraform-google-ai-on-gke

## Description

This module is responsible for the following actions:

- store an HTCondor Pool password in Google Cloud Secret Manager
  - will generate a new password if one is not supplied
- create a secret in Google Cloud Secret Manager in which the HTCondor central
  manager can place IDTOKENs (JWT Authorizations) for execute points to download
- create a Toolkit runner for the central manager
  - download the POOL password / signing key
  - create a local IDTOKEN for itself
  - upload the execute point IDTOKEN secret
- create a Toolkit runner for access points
  - download the POOL password / signing key
  - create a local IDTOKEN for itself
- create a Toolkit runner for execute points
  - Fetch the IDTOKEN secret generated by the central manager

It is expected to be used with the [htcondor-install] and
[htcondor-execute-point] modules.

[hpcvmimage]: https://cloud.google.com/compute/docs/instances/create-hpc-vm
[htcondor-install]: ../../scripts/htcondor-setup/README.md
[htcondor-execute-point]: ../../compute/htcondor-execute-point/README.md

[htcrole]: https://htcondor.readthedocs.io/en/latest/getting-htcondor/admin-quick-start.html#what-get-htcondor-does-to-configure-a-role

### Example

The following code snippet uses this module to create a startup script that
installs HTCondor software and configures an HTCondor Central Manager. A full
example can be found in the [examples README][htc-example].

[htc-example]: ../../../../examples/README.md#htc-htcondoryaml--

```yaml
- id: network1
  source: modules/network/pre-existing-vpc

- id: htcondor_install
  source: community/modules/scripts/htcondor-install

- id: htcondor_setup
  source: community/modules/scheduler/htcondor-setup
  use:
  - network1

- id: htcondor_secrets
  source: community/modules/scheduler/htcondor-pool-secrets
  use:
  - htcondor_setup 

  - id: htcondor_startup_central_manager
    source: modules/scripts/startup-script
    settings:
      runners:
      - $(htcondor_install.install_htcondor_runner)
      - $(htcondor_secrets.central_manager_runner)
      - $(htcondor_setup.central_manager_runner)

- id: htcondor_cm
  source: modules/compute/vm-instance
  use:
  - network1
  - htcondor_startup_central_manager
  settings:
    name_prefix: cm0
    machine_type: c2-standard-4
    disable_public_ips: true
    service_account:
      email: $(htcondor_setup.central_manager_service_account)
      scopes:
      - cloud-platform
    network_interfaces:
    - network: null
      subnetwork: $(network1.subnetwork_self_link)
      subnetwork_project: $(vars.project_id)
      network_ip: $(htcondor_setup.central_manager_internal_ip)
      stack_type: null
      access_config: []
      ipv6_access_config: []
      alias_ip_range: []
      nic_type: VIRTIO_NET
      queue_count: null
  outputs:
  - internal_ip
```

## Support

HTCondor is maintained by the [Center for High Throughput Computing][chtc] at
the University of Wisconsin-Madison. Support for HTCondor is available via:

- [Discussion lists](https://htcondor.org/mail-lists/)
- [HTCondor on GitHub](https://github.com/htcondor/htcondor/)
- [HTCondor manual](https://htcondor.readthedocs.io/en/latest/)

[chtc]: https://chtc.cs.wisc.edu/

## License

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| access\_point\_service\_account\_email | HTCondor access point service account e-mail | `string` | n/a | yes |
| central\_manager\_service\_account\_email | HTCondor access point service account e-mail | `string` | n/a | yes |
| deployment\_name | Cluster Toolkit deployment name. HTCondor cloud resource names will include this value. | `string` | n/a | yes |
| execute\_point\_service\_account\_email | HTCondor access point service account e-mail | `string` | n/a | yes |
| labels | Labels to add to resources. List key, value pairs. | `map(string)` | n/a | yes |
| pool\_password | HTCondor Pool Password | `string` | `null` | no |
| project\_id | Project in which HTCondor pool will be created | `string` | n/a | yes |
| trust\_domain | Trust domain for HTCondor pool (if not supplied, will be set based on project\_id) | `string` | `""` | no |
| user\_managed\_replication | Replication parameters that will be used for defined secrets | <pre>list(object({<br>    location     = string<br>    kms_key_name = optional(string)<br>  }))</pre> | `[]` | no |

## Outputs

| Name | Description |
|------|-------------|
| access\_point\_runner | Toolkit Runner to download pool secrets to an HTCondor access point |
| central\_manager\_runner | Toolkit Runner to download pool secrets to an HTCondor central manager |
| execute\_point\_runner | Toolkit Runner to download pool secrets to an HTCondor execute point |
| pool\_password\_secret\_id | Google Cloud Secret Manager ID containing HTCondor Pool Password |
| windows\_startup\_ps1 | PowerShell script to download pool secrets to an HTCondor execute point |

<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
