## Description

This module creates a script that defines a software build using Spack and
performs any additional customization to a Spack installation.

There are two main variable inputs that can be used to define a Spack build:
`data_files` and `commands`.

- `data_files`: Any files specified will be transferred to the machine running
  outputted script. Data file `content` can be defined inline in the blueprint
  or can point to a `source`, an absolute local path of a file. This can be used
  to transfer environment definition files, config definition files, GPG keys,
  or software licenses. `data_files` are transferred before `commands` are run.
- `commands`: A script that is run. This can be used to perform actions such as
  installation of compilers & packages, environment creation, adding a build
  cache, and modifying the spack configuration.

## Example

The `spack-execute` module should `use` a `spack-setup` module. This will
prepend the installation of Spack and its dependencies to the build. Then
`spack-execute` can be used by a module that takes `startup-script` as an input.

```yaml
  - id: spack-setup
    source: community/modules/scripts/spack-setup

  - id: spack-build
    source: community/modules/scripts/spack-execute
    use: [spack-setup]
    settings:
      commands: |
        spack install gcc@10.3.0 target=x86_64

  - id: builder-vm
    source: modules/compute/vm-instance
    use: [network1, spack-build]
```

To see a full example of this module in use, see the [hpc-slurm-gromacs.yaml] example.

[hpc-slurm-gromacs.yaml]: ../../../examples/hpc-slurm-gromacs.yaml

### Using with `startup-script` module

The `spack-runner` output can be used by the `startup-script` module.

```yaml
  - id: spack-setup
    source: community/modules/scripts/spack-setup

  - id: spack-build
    source: community/modules/scripts/spack-execute
    use: [spack-setup]
    settings:
      commands: |
        spack install gcc@10.3.0 target=x86_64

  - id: startup-script
    source: modules/scripts/startup-script
    settings:
      runners:
      - $(spack-build.spack-runner)
      - type: shell
        destination: "my-script.sh"
        content: echo 'hello world'

  - id: workstation
    source: modules/compute/vm-instance
    use: [network1, startup-script]
```

## License

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| commands | String of commands to run within this module | `string` | `null` | no |
| data\_files | A list of files to be transferred prior to running commands. <br>It must specify one of 'source' (absolute local file path) or 'content' (string).<br>It must specify a 'destination' with absolute path where file should be placed. | `list(map(string))` | `[]` | no |
| deployment\_name | Name of deployment, used to name bucket containing spack scripts. | `string` | n/a | yes |
| gcs\_bucket\_path | The GCS path for storage bucket and the object, starting with `gs://`. | `string` | n/a | yes |
| labels | Key-value pairs of labels to be added to created resources. | `map(string)` | n/a | yes |
| log\_file | Defines the logfile that script output will be written to | `string` | `"/var/log/spack.log"` | no |
| project\_id | Project in which the HPC deployment will be created. | `string` | n/a | yes |
| region | Region to place bucket containing spack scripts. | `string` | n/a | yes |
| spack\_profile\_script\_path | Path to the Spack profile.d script. Created by an instance of spack-setup.<br>Can be defined explicitly, or by chaining an instance of a spack-setup module<br>through a `use` setting. | `string` | n/a | yes |
| spack\_runner | Runner from previous spack-setup or spack-execute to be chained with scripts generated by this module. | <pre>object({<br>    type        = string<br>    content     = string<br>    destination = string<br>  })</pre> | n/a | yes |
| system\_user\_name | Name of the system user used to execute commands. Generally passed from the spack-setup module. | `string` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| controller\_startup\_script | Spack startup script, duplicate for SLURM controller. |
| gcs\_bucket\_path | Bucket containing the startup scripts for spack, to be reused by spack-execute module. |
| spack\_profile\_script\_path | Path to the Spack profile.d script. |
| spack\_runner | Single runner that combines scripts from this module and any previously chained spack-execute or spack-setup modules. |
| startup\_script | Spack startup script. |
| system\_user\_name | The system user used to execute commands. |

<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
